<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> proj.4多线程支持说明 · Hexo</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">Home</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   Blog</a></li><li class="nav-list-item"><a href="https://github.com/xxxxxx" target="_blank" class="nav-link">github</a></li><li class="nav-list-item"><a href="https://coding.net/u/xxxxxx" target="_blank" class="nav-link">coding</a></li><li class="nav-list-item"><a href="http://weibo.com/xxxxxx" target="_blank" class="nav-link">weibo</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2019/12/31/proj-4-multithread-supprot/" class="post-title-link">proj.4多线程支持说明</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/proj-4-多线程/" class="post-tag-link">proj.4 多线程</a></li></ul><div class="post-time">Tuesday, December 31st 2019</div></div><div class="post-content"><p>最近对公司的平台进行多线程绘制改造，咱们公司使用的坐标转换时基于proj.4做的，版本是4.7，偶尔出现部分坐标点转换失败的错误。经过查资料，版本4.7对多线程支持不够友好，于是升级到项目（vs2005）所支持的最高版本5.2，结果还是出现问题。查看5.2版本源码，里面加了大量互斥锁相关内容，感觉这次更新方向是对的，但是还需要完善某些地方。于是调试代码，看哪里导致错误。<br>发现每个坐标定义对象PJ都有一个上下文的成员变量。一旦last_error非0时，就会停止转换。<br><img src="https://i.loli.net/2019/12/31/8y5KSv91XmHaqCk.png" alt=""><br><img src="https://i.loli.net/2019/12/31/HQxVY2auOMWm67X.png" alt=""><br>于是查找这个变量设置值得地方：<br><img src="https://i.loli.net/2019/12/31/FwfeOku5XHsxWrV.png" alt=""></p>
<p>发现默认的last_error变量是全局共享的，项目在多个线程之中使用这样一句代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pj_init_plus(&quot;&quot;)</span><br></pre></td></tr></table></figure>
<p>由于pj_init_plus传的值是空字符串，导致此处会设置last_error为-1。由于程序是多线程跑的，其他地方使用坐标转换的时候，发现last_error为-1，就会停止转换导致错误。</p>
<p>官网给出了多线程处理方案：<br><a href="https://proj.org/development/threads.html" target="_blank" rel="noopener">https://proj.org/development/threads.html</a><br>每个线程定义自己的上下文对象。<br><img src="https://i.loli.net/2019/12/31/8iAGsWOgYPt2Tw5.png" alt=""></p>
<p>个人认为，如果某个PJ对象可能在多个线程之中运行，一个PJ对象绑定一个上下文对象也是未尝不可的。</p>
</div></article><div class="pagination"><a href="/2019/12/31/centos7-compile-libwebp/" class="pagination-prev">PREV</a><a href="/2019/12/31/proj-4-verson-update-explain/" class="pagination-next">NEXT</a></div><div class="comments"></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/boost1-72-centos/" rel="tag">boost1.72 centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7-cximage/" rel="tag">centos7 cximage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7-libwebp/" rel="tag">centos7 libwebp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cximage-freeimage/" rel="tag">cximage freeimage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proj-4-%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">proj.4 多线程</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/07/06/windows-NSIS-package-setup-error/">'windows_NSIS_package_setup_error'</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/31/centos7-compile-libwebp/">centos7编译libwebp</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/31/proj-4-multithread-supprot/">proj.4多线程支持说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/31/proj-4-verson-update-explain/">proj.4版本升级到5.x、6.x说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/30/centos7-Compile-freeimage/">centos7编译freeimage库</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/30/centos7-Compile-cximage/">centos7环境编译CxImage</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/29/centos7-Compile-boost-blog/">centos7如何编译boost1.72库</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2025 <a href="/">John Doe</P></div><div class="power"><p><a href="http://pinggod.com/" target="_blank" rel="noopener">Sean Sun</a>, 
<a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>, 
<a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>, 
<a href="https://jekyllrb.com/" target="_blank" rel="noopener">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80781234-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?ee75cf111111aa99f8540efa2570970";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>